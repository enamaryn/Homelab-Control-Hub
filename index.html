<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Homelab Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Portail homelab - Acc√®s centralis√© aux services self-hosted" />
  <style>
    /* ==========================================================================
       1. VARIABLES & THEMES
       ========================================================================== */
    :root {
      /* Couleurs de base */
      --bg: #050712;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.4);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
      --success: #22c55e;

      /* Layout */
      --radius-sm: 8px;
      --radius-md: 14px;
      --radius-lg: 18px;
      --radius-xl: 24px;
      --radius-full: 999px;

      /* Effets */
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.45);
      --shadow-glow: 0 0 26px var(--accent-soft);
      --transition-fast: 0.18s ease-out;
      --glass: rgba(15, 23, 42, 0.75);
      --border-subtle: rgba(148, 163, 184, 0.15);

      /* Z-index */
      --z-header: 3;
      --z-fab: 5;
      --z-modal: 10;
      --z-auth: 999;
    }

    :root[data-theme="dark"] {
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.4);
      --glass: rgba(15, 23, 42, 0.78);
      --border-subtle: rgba(148, 163, 184, 0.25);
    }

    :root[data-theme="neon"] {
      --accent: #a855f7;
      --accent-soft: rgba(168, 85, 247, 0.5);
      --glass: radial-gradient(circle at top left, rgba(15,23,42,0.95), #020617);
      --border-subtle: rgba(168, 85, 247, 0.45);
    }

    :root[data-theme="minimal"] {
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.4);
      --glass: rgba(15, 23, 42, 0.9);
      --border-subtle: rgba(148, 163, 184, 0.3);
    }

    /* ==========================================================================
       2. RESET & BASE
       ========================================================================== */
    *, *::before, *::after { box-sizing: border-box; }

    html, body {
      height: auto;
      min-height: 100%;
      overflow-x: hidden;
      overflow-y: auto;
    }

    body {
      margin: 0;
      padding: clamp(14px, 2.5vw, 28px);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617, #020617 40%, #000000);
      color: var(--text);
      line-height: 1.5;
    }

    /* Focus visible global */
    :focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 3px;
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    /* Skip link pour accessibilit√© */
    .skip-link {
      position: absolute;
      top: -100%;
      left: 0;
      padding: 8px 16px;
      background: var(--accent);
      color: #020617;
      font-weight: 600;
      z-index: 9999;
      border-radius: var(--radius-sm);
    }

    .skip-link:focus {
      top: 10px;
      left: 10px;
    }

    /* ==========================================================================
       3. LAYOUT PRINCIPAL
       ========================================================================== */
    .app-shell {
      width: 100%;
      max-width: 1800px;
      margin-inline: auto;
      background:
        linear-gradient(135deg, rgba(56, 189, 248, 0.05), rgba(168, 85, 247, 0.03)),
        radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), #020617);
      border-radius: var(--radius-xl);
      padding: clamp(16px, 2.4vw, 24px) clamp(14px, 3vw, 26px) clamp(18px, 3vw, 28px);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.3);
      position: relative;
      overflow: visible;
    }

    .matrix-bg {
      position: absolute;
      inset: 0;
      opacity: 0.09;
      pointer-events: none;
      background-image: radial-gradient(circle at 1px 1px, var(--accent) 1px, transparent 0);
      background-size: 18px 18px;
      mix-blend-mode: screen;
      border-radius: inherit;
    }

    .app-content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
    }

    /* ==========================================================================
       4. HEADER
       ========================================================================== */
    header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 14px;
      position: sticky;
      top: 0;
      z-index: var(--z-header);
      padding-bottom: 10px;
      background: linear-gradient(
        to bottom,
        rgba(15, 23, 42, 0.98),
        rgba(15, 23, 42, 0.9),
        rgba(15, 23, 42, 0.75),
        transparent 95%
      );
      backdrop-filter: blur(10px);
    }

    .logo-circle {
      width: 46px;
      height: 46px;
      border-radius: var(--radius-full);
      background: radial-gradient(circle at 30% 20%, var(--accent), #0f172a);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 25px var(--accent-soft);
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }

    .logo-circle::after {
      content: "";
      position: absolute;
      inset: 1px;
      border-radius: inherit;
      border: 1px solid rgba(15, 23, 42, 0.6);
    }

    .logo-circle span {
      font-size: 1.4rem;
      font-weight: 700;
      color: #e5f2ff;
      letter-spacing: 0.06em;
    }

    .logo-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .title-block {
      flex: 1;
      min-width: 0;
    }

    .title-block h1 {
      margin: 0;
      font-size: clamp(1.25rem, 2.5vw, 1.7rem);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .title-block p {
      margin: 3px 0 0;
      font-size: clamp(0.78rem, 1.4vw, 0.92rem);
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .title-block p span {
      color: var(--accent);
      text-shadow: 0 0 10px var(--accent-soft);
    }

    .top-actions {
      margin-left: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
      flex-shrink: 0;
    }

    .clock {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: clamp(0.78rem, 1.2vw, 0.9rem);
      color: var(--muted);
      padding: 4px 10px;
      border-radius: var(--radius-full);
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    /* ==========================================================================
       5. BARRE DE RECHERCHE
       ========================================================================== */
    .search-bar {
      margin: 6px 0 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-wrapper {
      position: relative;
      flex: 1;
      min-width: 200px;
    }

    .search-wrapper input {
      width: 100%;
      padding: clamp(8px, 1.8vw, 10px) clamp(10px, 2vw, 12px) clamp(8px, 1.8vw, 10px) 32px;
      border-radius: var(--radius-full);
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      font-size: clamp(0.82rem, 1.4vw, 0.9rem);
      outline: none;
      transition: border var(--transition-fast), box-shadow var(--transition-fast),
        background var(--transition-fast), transform var(--transition-fast);
    }

    .search-wrapper input::placeholder {
      color: rgba(148, 163, 184, 0.7);
    }

    .search-wrapper input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background: #020617;
      transform: translateY(-0.5px);
    }

    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.85rem;
      color: var(--muted);
      pointer-events: none;
    }

    .quick-info {
      font-size: clamp(0.74rem, 1.2vw, 0.84rem);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: var(--radius-full);
      border: 1px dashed rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.85);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .quick-info span {
      color: var(--accent);
      font-size: 0.88rem;
    }

    /* ==========================================================================
       6. BANDEAU CAMERAS
       ========================================================================== */
    .camera-strip {
      margin-bottom: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: clamp(8px, 2vw, 12px);
    }

    .camera-card {
      position: relative;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      cursor: pointer;
      min-height: 70px;
      transition: border-color var(--transition-fast), transform var(--transition-fast);
    }

    .camera-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .camera-card-inner {
      position: relative;
      width: 100%;
      padding-top: 56%;
      overflow: hidden;
    }

    .camera-card img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: brightness(0.9) contrast(1.02);
      transition: transform var(--transition-fast), filter var(--transition-fast);
    }

    .camera-card:hover img {
      transform: scale(1.03);
      filter: brightness(1) contrast(1.05);
    }

    .camera-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(15, 23, 42, 0.85), transparent 60%);
      pointer-events: none;
    }

    .camera-label {
      position: absolute;
      left: 6px;
      bottom: 4px;
      font-size: clamp(0.68rem, 1.1vw, 0.74rem);
      padding: 2px 7px;
      border-radius: var(--radius-full);
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text);
      max-width: calc(100% - 12px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .camera-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: var(--muted);
      padding: 4px;
      text-align: center;
    }

    /* Vue modale camera */
    .camera-modal-view {
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #020617;
      max-height: 60vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .camera-modal-view img {
      max-width: 100%;
      max-height: 60vh;
      width: auto;
      height: auto;
      display: none;
    }

    #camera-modal-placeholder {
      position: static;
      inset: auto;
      min-height: 120px;
    }

    /* ==========================================================================
       7. ONGLETS / TABS
       ========================================================================== */
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .tabs::-webkit-scrollbar { height: 0; }
    .tabs { scrollbar-width: none; }

    .tab-btn {
      padding: clamp(7px, 1.4vw, 10px) clamp(12px, 2vw, 16px);
      border-radius: var(--radius-full);
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      font-size: clamp(0.75rem, 1.2vw, 0.85rem);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background var(--transition-fast), color var(--transition-fast),
        border var(--transition-fast), transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    .tab-btn span { font-size: 0.85rem; }

    .tab-btn.active {
      background: radial-gradient(circle at top, var(--accent), #4f46e5);
      color: #020617;
      border-color: rgba(191, 219, 254, 0.9);
      box-shadow: 0 0 14px var(--accent-soft);
      transform: translateY(-1px);
    }

    .tab-btn:not(.active):hover {
      border-color: var(--accent-soft);
      color: var(--text);
    }

    /* ==========================================================================
       8. PANEL & GRILLE DE TILES
       ========================================================================== */
    main {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .panel {
      border-radius: var(--radius-lg);
      background: var(--glass);
      border: 1px solid var(--border-subtle);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.65);
      padding: clamp(14px, 2vw, 18px);
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .panel-header h2 {
      margin: 0;
      font-size: clamp(0.9rem, 1.4vw, 1.05rem);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(249, 250, 251, 0.9);
    }

    .panel-header h2 span { color: var(--accent); }

    .panel-header small {
      font-size: clamp(0.68rem, 1.1vw, 0.78rem);
      color: var(--muted);
    }

    .tiles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: clamp(10px, 2vw, 14px);
      flex: 1;
      min-height: 0;
      padding-right: 4px;
    }

    .tiles-grid::-webkit-scrollbar { width: 6px; }
    .tiles-grid::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.6);
      border-radius: var(--radius-full);
    }
    .tiles-grid::-webkit-scrollbar-track { background: transparent; }

    .tiles-empty {
      font-size: 0.8rem;
      color: var(--muted);
      padding: 8px;
      text-align: center;
    }

    /* ==========================================================================
       9. TILE / RACCOURCI
       ========================================================================== */
    .tile {
      position: relative;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: clamp(10px, 2vw, 12px);
      background: radial-gradient(circle at top left, #0b1120, #020617);
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast),
        border-color var(--transition-fast), background var(--transition-fast);
      text-align: left;
    }

    .tile:hover,
    .tile:focus-within {
      transform: translateY(-3px) scale(1.01);
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.8);
      border-color: var(--accent);
      background: radial-gradient(circle at top, #0b1120, #020617);
    }

    .tile-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tile-logo {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      background: radial-gradient(circle at top left, var(--accent), #0f172a);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      color: #e5f2ff;
      overflow: hidden;
      flex-shrink: 0;
      border: 1px solid rgba(15, 23, 42, 0.8);
    }

    .tile-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .tile-title {
      font-size: clamp(0.86rem, 1.4vw, 1rem);
      font-weight: 600;
      color: #f9fafb;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .tile-sub {
      font-size: clamp(0.72rem, 1.2vw, 0.82rem);
      color: var(--muted);
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .chip {
      align-self: flex-start;
      margin-top: 2px;
      padding: clamp(3px, 0.8vw, 5px) clamp(8px, 1.6vw, 10px);
      border-radius: var(--radius-full);
      font-size: clamp(0.64rem, 1vw, 0.74rem);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid var(--accent-soft);
      color: #7dd3fc;
      background: rgba(8, 47, 73, 0.4);
    }

    .tile-edit {
      position: absolute;
      top: 6px;
      right: 8px;
      width: 22px;
      height: 22px;
      border-radius: var(--radius-full);
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      color: var(--muted);
      opacity: 0;
      transform: translateY(-3px);
      pointer-events: none;
      transition: opacity var(--transition-fast), transform var(--transition-fast),
        background var(--transition-fast), color var(--transition-fast),
        border var(--transition-fast);
    }

    .tile:hover .tile-edit,
    .tile:focus-within .tile-edit {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .tile-edit:hover {
      background: radial-gradient(circle at top, var(--accent), #4f46e5);
      color: #020617;
      border-color: rgba(191, 219, 254, 0.9);
    }

    /* Status dot */
    .tile-status-dot {
      position: absolute;
      bottom: 6px;
      right: 8px;
      width: 10px;
      height: 10px;
      border-radius: var(--radius-full);
      background: #6b7280;
      box-shadow: 0 0 0 0 rgba(148, 163, 184, 0.5);
    }

    .tile-status-up {
      background: var(--success);
      box-shadow: 0 0 6px 0 rgba(34, 197, 94, 0.9);
      animation: pulse-up 2s infinite;
    }

    .tile-status-down {
      background: #ef4444;
      box-shadow: 0 0 6px 0 rgba(239, 68, 68, 0.9);
      animation: pulse-down 1.5s infinite;
    }

    .tile-status-unknown {
      background: #6b7280;
      box-shadow: 0 0 4px 0 rgba(107, 114, 128, 0.8);
    }

    @keyframes pulse-up {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
      70% { box-shadow: 0 0 0 7px rgba(34, 197, 94, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }

    @keyframes pulse-down {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 7px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    /* ==========================================================================
       10. FOOTER
       ========================================================================== */
    footer {
      margin-top: 10px;
      font-size: clamp(0.68rem, 1vw, 0.76rem);
      color: rgba(148, 163, 184, 0.75);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    footer span { opacity: 0.85; }
    footer span strong { color: var(--accent); }

    /* ==========================================================================
       11. FAB (Floating Action Buttons)
       ========================================================================== */
    .fab {
      position: absolute;
      right: 20px;
      bottom: calc(20px + env(safe-area-inset-bottom));
      width: 46px;
      height: 46px;
      border-radius: var(--radius-full);
      border: 1px solid rgba(191, 219, 254, 0.8);
      background: radial-gradient(circle at top, var(--accent), #4f46e5);
      color: #020617;
      font-size: 1.7rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-glow);
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
      z-index: var(--z-fab);
    }

    .fab:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 0 32px var(--accent-soft);
    }

    .settings-btn {
      position: absolute;
      right: 78px;
      bottom: calc(22px + env(safe-area-inset-bottom));
      width: 38px;
      height: 38px;
      border-radius: var(--radius-full);
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.96);
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.9);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast),
        background var(--transition-fast), color var(--transition-fast),
        border var(--transition-fast);
      z-index: var(--z-fab);
    }

    .settings-btn:hover {
      transform: translateY(-1px);
      background: radial-gradient(circle at top, #111827, #020617);
      color: var(--accent);
      border-color: var(--accent-soft);
      box-shadow: var(--shadow-glow);
    }

    /* ==========================================================================
       12. MODALES
       ========================================================================== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.88);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: var(--z-modal);
      opacity: 1;
      visibility: visible;
      transition: opacity var(--transition-fast), visibility var(--transition-fast);
    }

    .modal-hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .modal-dialog {
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      box-shadow: 0 20px 45px rgba(0, 0, 0, 0.75);
      padding: 18px 18px 16px;
      position: relative;
      margin: 10px;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .modal-header h2 span { color: var(--accent); }

    .modal-close {
      width: 26px;
      height: 26px;
      border-radius: var(--radius-full);
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      color: var(--muted);
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast),
        transform var(--transition-fast), border var(--transition-fast);
    }

    .modal-close:hover {
      background: rgba(127, 29, 29, 0.95);
      color: #fecaca;
      border-color: rgba(248, 113, 113, 0.8);
      transform: rotate(8deg);
    }

    .modal-body { margin-bottom: 8px; }

    /* ==========================================================================
       13. OVERLAY AUTHENTIFICATION
       ========================================================================== */
    .auth-backdrop {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.12), rgba(2, 6, 23, 0.92));
      backdrop-filter: blur(16px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: var(--z-auth);
      opacity: 1;
      visibility: visible;
      transition: opacity var(--transition-fast), visibility var(--transition-fast);
    }

    .auth-backdrop.auth-hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .auth-card {
      background: var(--glass);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 24px;
      width: min(440px, calc(100% - 32px));
      box-shadow: var(--shadow-soft);
    }

    .auth-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 14px;
    }

    .auth-header h2 {
      margin: 0;
      font-size: 1.1rem;
      letter-spacing: 0.04em;
    }

    .auth-hint {
      margin-top: 10px;
      font-size: 0.88rem;
      color: var(--muted);
      line-height: 1.4;
    }

    .auth-note {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(56, 189, 248, 0.08);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(56, 189, 248, 0.2);
      font-size: 0.88rem;
    }

    /* ==========================================================================
       14. FORMULAIRES
       ========================================================================== */
    .form-group { margin-bottom: 10px; }

    .form-group label {
      display: block;
      font-size: clamp(0.74rem, 1.1vw, 0.82rem);
      margin-bottom: 4px;
      color: rgba(209, 213, 219, 0.9);
    }

    .form-group input[type="text"],
    .form-group input[type="url"],
    .form-group input[type="password"],
    .form-group select {
      width: 100%;
      padding: clamp(8px, 1.6vw, 10px) clamp(10px, 2vw, 12px);
      border-radius: var(--radius-full);
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      font-size: clamp(0.78rem, 1.2vw, 0.88rem);
      outline: none;
      transition: border var(--transition-fast), box-shadow var(--transition-fast),
        background var(--transition-fast), transform var(--transition-fast);
    }

    .form-group input[type="password"] {
      -webkit-text-fill-color: var(--text);
      caret-color: var(--accent);
    }

    .form-group input::placeholder { color: rgba(148, 163, 184, 0.7); }

    .form-group input:focus,
    .form-group select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background: #020617;
      transform: translateY(-0.5px);
    }

    .password-field {
      position: relative;
      display: flex;
      align-items: center;
    }

    .password-field input { padding-right: 38px; }

    .password-toggle {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid var(--border-subtle);
      color: var(--muted);
      border-radius: var(--radius-full);
      width: 30px;
      height: 30px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: color var(--transition-fast), border var(--transition-fast),
        background var(--transition-fast);
    }

    .password-toggle:hover,
    .password-toggle.password-visible {
      color: var(--text);
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.08);
    }

    .file-input-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: clamp(0.72rem, 1vw, 0.8rem);
      color: var(--muted);
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .file-label {
      padding: 6px 10px;
      border-radius: var(--radius-full);
      border: 1px dashed rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .file-label span { font-size: 0.85rem; }

    .file-hint {
      font-size: clamp(0.68rem, 1vw, 0.78rem);
      color: var(--muted);
      margin-top: 4px;
    }

    .auth-actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
    }

    .auth-actions .btn {
      width: 100%;
      justify-content: center;
    }

    /* ==========================================================================
       15. BOUTONS
       ========================================================================== */
    .btn-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: var(--radius-full);
      border: none;
      padding: clamp(8px, 1.6vw, 10px) clamp(14px, 2.4vw, 18px);
      font-size: clamp(0.78rem, 1.2vw, 0.88rem);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast),
        background var(--transition-fast), opacity var(--transition-fast);
      white-space: nowrap;
    }

    .btn-primary {
      background: radial-gradient(circle at top, var(--accent), #4f46e5);
      color: #0b1020;
      box-shadow: 0 0 18px var(--accent-soft);
      font-weight: 600;
      border: 1px solid rgba(191, 219, 254, 0.7);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: var(--shadow-glow);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(30, 64, 175, 0.7);
      color: #e5e7eb;
    }

    .btn-danger {
      background: rgba(127, 29, 29, 0.9);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.7);
    }

    .btn-danger:hover { background: rgba(185, 28, 28, 0.95); }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: none;
      padding: 0;
      font-size: clamp(0.7rem, 1vw, 0.78rem);
      cursor: pointer;
    }

    .btn-ghost span { text-decoration: underline dotted; }

    /* ==========================================================================
       16. STATUS & FEEDBACK
       ========================================================================== */
    .status {
      font-size: clamp(0.72rem, 1vw, 0.8rem);
      color: var(--muted);
      margin-top: 6px;
      min-height: 1.2em;
    }

    .status span.ok { color: var(--success); }
    .status span.err { color: var(--danger); }

    .modal-footer-actions {
      margin-top: 8px;
      font-size: clamp(0.68rem, 1vw, 0.76rem);
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .modal-footer-actions code { font-size: 0.7rem; }

    /* ==========================================================================
       17. RESPONSIVE
       ========================================================================== */
    @media (max-width: 480px) {
      header { flex-wrap: wrap; }

      .title-block h1,
      .title-block p { white-space: normal; }

      .top-actions {
        width: 100%;
        align-items: flex-start;
      }

      .search-bar { gap: 8px; }

      .search-wrapper,
      .quick-info { width: 100%; }

      .quick-info { justify-content: flex-start; }

      .camera-strip { grid-template-columns: 1fr; }

      .tabs {
        flex-wrap: nowrap;
        overflow-x: auto;
        padding-bottom: 4px;
      }

      .tab-btn,
      .btn,
      .modal-close,
      .settings-btn,
      .fab { min-height: 44px; }

      .fab {
        width: 44px;
        height: 44px;
        right: 16px;
        bottom: calc(16px + env(safe-area-inset-bottom));
      }

      .settings-btn {
        width: 44px;
        height: 44px;
        right: 68px;
        bottom: calc(16px + env(safe-area-inset-bottom));
      }

      .modal-dialog {
        max-width: 95vw;
        max-height: 90vh;
        margin: 10px;
      }
    }

    @media (min-width: 481px) and (max-width: 768px) {
      header { flex-wrap: wrap; }

      .top-actions {
        margin-left: 0;
        align-items: flex-start;
      }

      .camera-strip { grid-template-columns: repeat(2, minmax(0, 1fr)); }

      .tiles-grid { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }

      .modal-dialog {
        max-width: 95vw;
        margin: 12px;
      }
    }

    @media (min-width: 769px) {
      .tiles-grid { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    }

    /* Screen reader only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <!-- Skip link pour accessibilit√© -->
  <a href="#tiles" class="skip-link">Aller au contenu principal</a>

  <div class="app-shell">
    <div class="matrix-bg" aria-hidden="true"></div>
    <div class="app-content">
      <header>
        <div class="logo-circle" id="logo-circle" aria-hidden="true">
          <span id="logo-text">HL</span>
        </div>
        <div class="title-block">
          <h1 id="main-title">Homelab Control Hub</h1>
          <p><span id="subtitle-span">Portail priv√© ‚Äì services locaux &amp; containers</span></p>
        </div>
        <div class="top-actions">
          <div class="clock" id="clock" aria-live="off" aria-label="Horloge">--:--:--</div>
        </div>
      </header>

      <div class="search-bar" role="search">
        <div class="search-wrapper">
          <span class="search-icon" aria-hidden="true">üîç</span>
          <input
            type="search"
            id="search"
            placeholder="Filtrer les services (ex : proxmox, media, download...)"
            aria-label="Filtrer les services"
            autocomplete="off"
          />
        </div>
        <div class="quick-info" aria-hidden="true">
          <span>TIP</span> Tape le nom du service pour le filtrer
        </div>
      </div>

      <!-- Bandeau cam√©ras -->
      <section class="camera-strip" id="camera-strip" aria-label="Aper√ßu des cam√©ras"></section>

      <!-- Navigation par onglets -->
      <nav class="tabs" id="tabs" role="tablist" aria-label="Cat√©gories de services"></nav>

      <main id="main-content">
        <section class="panel" aria-labelledby="panel-title">
          <div class="panel-header">
            <h2 id="panel-title"><span>Services</span> &amp; Containers</h2>
            <small>Cliquer pour ouvrir ‚Äì survoler pour √©diter</small>
          </div>
          <div class="tiles-grid" id="tiles" role="list" aria-label="Liste des services"></div>
        </section>
      </main>

      <footer>
        <span>‚öôÔ∏è Startpage homelab ‚Äì 100% HTML/JS, sans backend.</span>
        <span>üîê Pense √† servir cette page uniquement sur ton r√©seau interne.</span>
      </footer>
    </div>

    <button class="fab" id="btn-open-modal" title="Ajouter un raccourci" aria-label="Ajouter un raccourci">+</button>
    <button class="settings-btn" id="btn-open-settings" title="Param√®tres du portail" aria-label="Param√®tres du portail">‚öôÔ∏è</button>
  </div>

  <!-- Modal Authentification -->
  <div class="auth-backdrop auth-hidden" id="auth-overlay" role="dialog" aria-modal="true" aria-labelledby="auth-title">
    <div class="auth-card">
      <div class="auth-header">
        <h2 id="auth-title">Acc√®s portail</h2>
        <span class="auth-note">üîí Session 1 jour</span>
      </div>
      <form id="auth-form" aria-describedby="auth-hint">
        <div class="form-group">
          <label for="auth-username">Identifiant</label>
          <input type="text" id="auth-username" autocomplete="username" required />
        </div>
        <div class="form-group">
          <label for="auth-password">Mot de passe</label>
          <div class="password-field">
            <input type="password" id="auth-password" autocomplete="current-password" required />
            <button
              type="button"
              class="password-toggle"
              id="auth-password-toggle"
              aria-label="Afficher le mot de passe"
              title="Maintenir pour afficher"
            >üëÅÔ∏è</button>
          </div>
        </div>
        <div class="btn-row">
          <button type="submit" class="btn btn-primary"><span aria-hidden="true">‚úÖ</span>Se connecter</button>
        </div>
        <div class="status" id="auth-status" role="status" aria-live="polite"></div>
        <div class="auth-actions">
          <button type="button" class="btn btn-secondary" id="auth-reset-btn">
            <span aria-hidden="true">‚ôªÔ∏è</span>R√©initialiser (admin / admin)
          </button>
        </div>
        <div class="auth-hint" id="auth-hint">
          L'identifiant et le mot de passe par d√©faut sont <strong>admin</strong> / <strong>admin</strong>.
          Tu peux les modifier depuis les param√®tres (‚öôÔ∏è). La session est retenue par un cookie valable jusqu'√† la fin de la journ√©e.
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Raccourcis -->
  <div class="modal-backdrop modal-hidden" id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-dialog">
      <div class="modal-header">
        <h2 id="modal-title"><span>Ajouter</span> un raccourci</h2>
        <button class="modal-close" id="modal-close" type="button" aria-label="Fermer">‚úï</button>
      </div>
      <form id="shortcut-form">
        <div class="modal-body">
          <div class="form-group">
            <label for="name">Nom du service</label>
            <input type="text" id="name" placeholder="Ex : Grafana, Portainer, Backups..." required />
          </div>
          <div class="form-group">
            <label for="url">URL</label>
            <input type="url" id="url" placeholder="https://mon-service.local:xxxx" required />
          </div>
          <div class="form-group">
            <label for="shortcut-tab">Onglet / Cat√©gorie</label>
            <select id="shortcut-tab"></select>
          </div>
          <div class="form-group">
            <label for="logo">Logo (optionnel)</label>
            <div class="file-input-wrapper">
              <div class="file-label"><span aria-hidden="true">üìÅ</span> Choisir une image</div>
              <input type="file" id="logo" accept="image/png,image/jpeg,image/webp,image/svg+xml" />
              <span id="file-name">(aucun fichier)</span>
            </div>
            <div class="file-hint">
              Ou indique une URL d'image (prioritaire) :
              <input type="url" id="logo-url" placeholder="https://exemple.com/logo.png" style="margin-top:6px;" />
            </div>
            <div class="file-hint">Formats : PNG / JPG / WebP / SVG, max ~100 Ko, image carr√©e (128‚Äì256 px).</div>
          </div>
          <div class="form-group">
            <label for="health-url">URL de sant√© (facultatif)</label>
            <input type="url" id="health-url" placeholder="https://mon-service.local/health" />
            <div class="file-hint">Utilis√© pour le check d'√©tat, s√©par√© de l'URL d'ouverture.</div>
          </div>
        </div>
        <div class="btn-row">
          <button type="submit" class="btn btn-primary"><span aria-hidden="true">üíæ</span> Sauvegarder</button>
          <button type="button" class="btn btn-secondary" id="btn-new-reset-form"><span aria-hidden="true">‚ú®</span> Nouveau</button>
          <button type="button" class="btn btn-danger" id="btn-delete" style="display:none;"><span aria-hidden="true">üóëÔ∏è</span> Supprimer</button>
        </div>
        <div class="status" id="status" role="status" aria-live="polite"></div>
        <div class="modal-footer-actions">
          <button type="button" class="btn-ghost" id="btn-empty-all"><span>Vider tous les raccourcis</span></button>
          <button type="button" class="btn-ghost" id="btn-restore-defaults"><span>Restaurer les valeurs par d√©faut</span></button>
        </div>
        <div class="modal-footer-actions">
          <span>üí° Tout est stock√© dans <code>localStorage</code> de ce navigateur.</span>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Param√®tres -->
  <div class="modal-backdrop modal-hidden" id="settings-modal" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
    <div class="modal-dialog">
      <div class="modal-header">
        <h2 id="settings-modal-title"><span>Param√®tres</span> du portail</h2>
        <button class="modal-close" id="settings-close" type="button" aria-label="Fermer">‚úï</button>
      </div>
      <form id="settings-form">
        <div class="modal-body">
          <div class="form-group">
            <label for="portal-title-input">Titre du portail</label>
            <input type="text" id="portal-title-input" placeholder="Ex : Homelab Control Hub" required />
          </div>
          <div class="form-group">
            <label for="portal-subtitle-input">Sous-titre</label>
            <input type="text" id="portal-subtitle-input" placeholder="Ex : Portail priv√© ‚Äì services locaux" required />
          </div>
          <div class="form-group">
            <label for="portal-logo-text">Texte du logo (si pas d'image)</label>
            <input type="text" id="portal-logo-text" placeholder="Ex : HL, DC, üß†..." />
          </div>
          <div class="form-group">
            <label for="portal-logo-file">Logo image (optionnel)</label>
            <div class="file-input-wrapper">
              <div class="file-label"><span aria-hidden="true">üìÅ</span> Choisir un logo</div>
              <input type="file" id="portal-logo-file" accept="image/png,image/jpeg,image/webp,image/svg+xml" />
              <span id="portal-logo-filename">(aucun fichier)</span>
            </div>
            <div class="file-hint">
              Ou URL d'image (prioritaire) :
              <input type="url" id="portal-logo-url" placeholder="https://exemple.com/logo.png" style="margin-top:6px;" />
            </div>
            <div class="file-hint">Formats : PNG / JPG / WebP / SVG, max ~100 Ko, image carr√©e.</div>
          </div>
          <div class="form-group">
            <label for="portal-theme-select">Th√®me visuel</label>
            <select id="portal-theme-select">
              <option value="dark">Sombre classique</option>
              <option value="neon">N√©on / Cyber</option>
              <option value="minimal">Minimal</option>
            </select>
          </div>

          <hr style="border: none; border-top: 1px solid rgba(148,163,184,0.4); margin: 10px 0;" />

          <div class="form-group">
            <label for="portal-auth-user">Identifiant de connexion</label>
            <input type="text" id="portal-auth-user" placeholder="Ex : admin, homer..." autocomplete="username" required />
            <div class="file-hint">Modifie l'utilisateur requis pour acc√©der au portail.</div>
          </div>
          <div class="form-group">
            <label for="portal-auth-pass">Mot de passe</label>
            <div class="password-field">
              <input type="password" id="portal-auth-pass" placeholder="Mot de passe requis au login" autocomplete="new-password" />
              <button type="button" class="password-toggle" id="portal-auth-pass-toggle" aria-label="Afficher le mot de passe" title="Maintenir pour afficher">üëÅÔ∏è</button>
            </div>
            <div class="file-hint">Laisse vide pour conserver le mot de passe actuel.</div>
          </div>

          <hr style="border: none; border-top: 1px solid rgba(148,163,184,0.4); margin: 10px 0;" />

          <div class="form-group">
            <label>Cam√©ras (HTTP snapshot / flux)</label>
            <div class="file-hint">
              Les navigateurs ne lisent pas le RTSP. Utilise des URL HTTP (snapshot, MJPEG, HLS via Frigate / NVR / Home Assistant).
            </div>
          </div>
          <div id="camera-settings-fields"></div>
        </div>

        <div class="btn-row">
          <button type="submit" class="btn btn-primary"><span aria-hidden="true">üíæ</span> Sauvegarder</button>
          <button type="button" class="btn btn-secondary" id="btn-reset-title"><span aria-hidden="true">‚ôªÔ∏è</span> Valeurs par d√©faut</button>
        </div>
        <div class="status" id="settings-status" role="status" aria-live="polite"></div>
        <div class="modal-footer-actions">
          <span>üß† R√©glages gard√©s dans <code>localStorage</code>.</span>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Cam√©ra plein √©cran -->
  <div class="modal-backdrop modal-hidden" id="camera-modal" role="dialog" aria-modal="true" aria-labelledby="camera-modal-heading">
    <div class="modal-dialog">
      <div class="modal-header">
        <h2 id="camera-modal-heading"><span>Cam√©ra</span> <span id="camera-modal-name"></span></h2>
        <button class="modal-close" id="camera-modal-close" type="button" aria-label="Fermer">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="camera-modal-view">
          <img id="camera-modal-img" alt="Flux cam√©ra" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" />
          <div id="camera-modal-placeholder" class="camera-placeholder">
            Configure l'URL snapshot HTTP de cette cam√©ra dans les param√®tres.
          </div>
        </div>
      </div>
      <div class="btn-row">
        <button type="button" class="btn btn-primary" id="camera-modal-open-tab"><span aria-hidden="true">üîó</span> Ouvrir dans un nouvel onglet</button>
        <button type="button" class="btn btn-secondary" id="camera-modal-close-bottom"><span aria-hidden="true">‚úï</span> Fermer</button>
      </div>
      <div class="status" id="camera-modal-status" role="status" aria-live="polite"></div>
    </div>
  </div>

  <script>
    /* ==========================================================================
       HOMELAB PORTAL - JavaScript
       Version consolid√©e avec accessibilit√© am√©lior√©e
       ========================================================================== */

    // ============================================================================
    // 1. CONSTANTES & CONFIGURATION
    // ============================================================================
    const CONFIG = {
      MAX_IMAGE_SIZE: 100 * 1024,
      HEALTH_CHECK_INTERVAL: 20000,
      HEALTH_TIMEOUT: 4500,
      DEFAULT_HEALTH_PATH: "/health",
      CAMERA_MODAL_REFRESH: 1000,
      CAMERA_STRIP_REFRESH: 15000,
      CLOCK_INTERVAL: 1000,
    };

    const STORAGE_KEYS = {
      LINKS: "homelab-links-v3",
      TITLE: "homelab-title-v2",
      TAB: "homelab-active-tab-v1",
      AUTH: "homelab-auth-v1",
    };

    const AUTH_COOKIE_NAME = "homelab-auth-session";

    const TABS = [
      { id: "all", label: "Tous", icon: "‚ú®" },
      { id: "core", label: "Serveurs", icon: "üß¨" },
      { id: "ai", label: "IA", icon: "üß†" },
      { id: "camera", label: "Cam√©ras", icon: "üìπ" },
      { id: "domotic", label: "Domotique", icon: "üè†" },
      { id: "media", label: "M√©dias", icon: "üé¨" },
      { id: "network", label: "R√©seau", icon: "üåê" },
      { id: "custom", label: "Custom", icon: "‚≠ê" },
    ];

    // URLs de sant√© : pr√©f√©rer des ressources statiques (images, favicon) accessibles sans auth
    const DEFAULT_LINKS = [
      { name: "Proxmox", url: "https://proxmox.local:8006", healthUrl: "https://proxmox.local:8006/pve-docs/images/logo-128.png", description: "Hyperviseur & VM / LXC", chip: "Core", icon: "üß¨", tab: "core" },
      { name: "Zoraxy", url: "https://zoraxy.local", healthUrl: "https://zoraxy.local/favicon.ico", description: "Reverse proxy / SSO", chip: "Edge", icon: "üõ°Ô∏è", tab: "network" },
      { name: "Docker / Portainer", url: "https://docker.local:9443", healthUrl: "https://docker.local:9443/favicon.ico", description: "Stacks & containers", chip: "Docker", icon: "üêã", tab: "core" },
      { name: "Transmission", url: "https://transmission.local", healthUrl: "https://transmission.local/favicon.ico", description: "Downloads & torrents", chip: "Media", icon: "üì°", tab: "media" },
      { name: "Emby", url: "https://emby.local:8096", healthUrl: "https://emby.local:8096/web/favicon.ico", description: "Serveur multim√©dia", chip: "Media", icon: "üé¨", tab: "media" },
      { name: "Home Assistant", url: "https://ha.local:8123", healthUrl: "https://ha.local:8123/static/icons/favicon.ico", description: "Domotique / IoT", chip: "SmartHome", icon: "üè†", tab: "domotic" },
      { name: "Frigate", url: "https://frigate.local", healthUrl: "https://frigate.local/favicon.ico", description: "NVR & d√©tection IA", chip: "Cam√©ra", icon: "üìπ", tab: "camera" },
      { name: "OpenWebUI / IA", url: "https://ai.local", healthUrl: "https://ai.local/favicon.png", description: "Interface IA locale", chip: "AI", icon: "üß†", tab: "ai" },
    ];

    const DEFAULT_AUTH = {
      username: "admin",
      passwordHash: "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918",
    };

    const DEFAULT_TITLE_SETTINGS = {
      title: "Homelab Control Hub",
      subtitle: "Portail priv√© ‚Äì services locaux & containers",
      logoText: "HL",
      logoImageUrl: "",
      logoImage: null,
      theme: "dark",
      cameras: [
        { name: "Entr√©e", snapshotUrl: "", clickUrl: "" },
        { name: "Jardin", snapshotUrl: "", clickUrl: "" },
        { name: "Garage", snapshotUrl: "", clickUrl: "" },
        { name: "Salon", snapshotUrl: "", clickUrl: "" },
      ],
    };

    // ============================================================================
    // 2. √âTAT GLOBAL
    // ============================================================================
    let state = {
      links: [],
      titleSettings: { ...DEFAULT_TITLE_SETTINGS },
      authSettings: { ...DEFAULT_AUTH },
      uiState: { activeTab: "all" },
      currentEditId: null,
      logoDataUrl: null,
      portalLogoDataUrl: null,
      statusDots: {},
      currentCameraModal: { name: "", snapshotUrl: "", clickUrl: "" },
      cameraModalIntervalId: null,
      openModals: [],
    };

    // ============================================================================
    // 3. UTILITAIRES
    // ============================================================================

    // G√©n√©ration d'ID unique
    const generateId = (prefix = "id") => `${prefix}-${Date.now()}-${Math.floor(Math.random() * 1e5)}`;

    // R√©cup√©ration s√©curis√©e d'√©l√©ments DOM
    const $ = (id) => document.getElementById(id);
    const $$ = (selector) => document.querySelectorAll(selector);

    // Stockage local s√©curis√©
    const storage = {
      get(key, fallback = null) {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : fallback;
        } catch (e) {
          console.error(`Erreur lecture localStorage (${key})`, e);
          return fallback;
        }
      },
      set(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
          return true;
        } catch (e) {
          console.error(`Erreur √©criture localStorage (${key})`, e);
          return false;
        }
      },
    };

    // Gestion des cookies
    const cookies = {
      get(name) {
        const found = (document.cookie || "")
          .split(";")
          .map((c) => c.trim())
          .find((c) => c.startsWith(`${name}=`));
        return found ? found.split("=")[1] : null;
      },
      set(name, value, expiresDate) {
        document.cookie = `${name}=${value}; expires=${expiresDate.toUTCString()}; path=/; SameSite=Lax`;
      },
      delete(name) {
        document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax`;
      },
    };

    // V√©rification si une ic√¥ne est une image
    const isImageIcon = (icon) =>
      typeof icon === "string" &&
      (icon.startsWith("data:image") || icon.startsWith("http://") || icon.startsWith("https://"));

    // ============================================================================
    // 4. CRYPTOGRAPHIE (SHA-256)
    // ============================================================================
    function rotateRight(value, amount) {
      return (value >>> amount) | (value << (32 - amount));
    }

    function sha256Fallback(data) {
      const k = [
        0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4,
        0xab1c5ed5, 0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe,
        0x9bdc06a7, 0xc19bf174, 0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f,
        0x4a7484aa, 0x5cb0a9dc, 0x76f988da, 0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7,
        0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967, 0x27b70a85, 0x2e1b2138, 0x4d2c6dfc,
        0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85, 0xa2bfe8a1, 0xa81a664b,
        0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070, 0x19a4c116,
        0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,
        0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7,
        0xc67178f2,
      ];

      const words = [];
      for (let i = 0; i < data.length; i++) {
        words[i >> 2] |= data[i] << ((3 - (i % 4)) * 8);
      }

      const bitLength = data.length * 8;
      words[bitLength >> 5] |= 0x80 << (24 - (bitLength % 32));
      words[(((bitLength + 64) >> 9) << 4) + 15] = bitLength;

      let [h0, h1, h2, h3, h4, h5, h6, h7] = [
        0x6a09e667, 0xbb67ae85, 0x3c6ef372, 0xa54ff53a,
        0x510e527f, 0x9b05688c, 0x1f83d9ab, 0x5be0cd19,
      ];

      const w = new Array(64);

      for (let i = 0; i < words.length; i += 16) {
        for (let t = 0; t < 16; t++) w[t] = words[i + t];
        for (let t = 16; t < 64; t++) {
          const s0 = rotateRight(w[t - 15], 7) ^ rotateRight(w[t - 15], 18) ^ (w[t - 15] >>> 3);
          const s1 = rotateRight(w[t - 2], 17) ^ rotateRight(w[t - 2], 19) ^ (w[t - 2] >>> 10);
          w[t] = (((w[t - 16] + s0) | 0) + ((w[t - 7] + s1) | 0)) | 0;
        }

        let [a, b, c, d, e, f, g, h] = [h0, h1, h2, h3, h4, h5, h6, h7];

        for (let t = 0; t < 64; t++) {
          const S1 = rotateRight(e, 6) ^ rotateRight(e, 11) ^ rotateRight(e, 25);
          const ch = (e & f) ^ (~e & g);
          const temp1 = (((h + S1) | 0) + ((ch + k[t]) | 0) + w[t]) | 0;
          const S0 = rotateRight(a, 2) ^ rotateRight(a, 13) ^ rotateRight(a, 22);
          const maj = (a & b) ^ (a & c) ^ (b & c);
          const temp2 = (S0 + maj) | 0;

          h = g; g = f; f = e;
          e = (d + temp1) | 0;
          d = c; c = b; b = a;
          a = (temp1 + temp2) | 0;
        }

        h0 = (h0 + a) | 0; h1 = (h1 + b) | 0;
        h2 = (h2 + c) | 0; h3 = (h3 + d) | 0;
        h4 = (h4 + e) | 0; h5 = (h5 + f) | 0;
        h6 = (h6 + g) | 0; h7 = (h7 + h) | 0;
      }

      return [h0, h1, h2, h3, h4, h5, h6, h7]
        .map((x) => (x >>> 0).toString(16).padStart(8, "0"))
        .join("");
    }

    async function hashPassword(value) {
      const data = new TextEncoder().encode(value);
      try {
        if (crypto?.subtle?.digest) {
          const hashBuffer = await crypto.subtle.digest("SHA-256", data);
          return Array.from(new Uint8Array(hashBuffer))
            .map((b) => b.toString(16).padStart(2, "0"))
            .join("");
        }
      } catch (e) {
        console.warn("WebCrypto indisponible, fallback SHA-256", e);
      }
      return sha256Fallback(data);
    }

    function normalizePasswordHash(hash) {
      if (typeof hash !== "string") return null;
      const normalized = hash.trim().toLowerCase();
      return /^[0-9a-f]{64}$/.test(normalized) ? normalized : null;
    }

    // ============================================================================
    // 5. GESTION DES MODALES (Accessibilit√©)
    // ============================================================================
    const modalManager = {
      focusableSelector: 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',
      previousFocus: null,

      open(modalId, focusFirst = true) {
        const modal = $(modalId);
        if (!modal) return;

        // Sauvegarder le focus actuel
        this.previousFocus = document.activeElement;

        // Afficher la modale
        modal.classList.remove("modal-hidden", "auth-hidden");
        state.openModals.push(modalId);

        // Focus trap
        if (focusFirst) {
          requestAnimationFrame(() => {
            const focusable = modal.querySelectorAll(this.focusableSelector);
            if (focusable.length) focusable[0].focus();
          });
        }

        // Pi√®ge de focus
        modal.addEventListener("keydown", this.trapFocus);
      },

      close(modalId) {
        const modal = $(modalId);
        if (!modal) return;

        modal.classList.add("modal-hidden");
        if (modalId === "auth-overlay") modal.classList.add("auth-hidden");

        state.openModals = state.openModals.filter((id) => id !== modalId);
        modal.removeEventListener("keydown", this.trapFocus);

        // Restaurer le focus
        if (this.previousFocus && typeof this.previousFocus.focus === "function") {
          this.previousFocus.focus();
        }
      },

      trapFocus(e) {
        if (e.key !== "Tab") return;

        const modal = e.currentTarget;
        const focusable = modal.querySelectorAll(modalManager.focusableSelector);
        if (!focusable.length) return;

        const first = focusable[0];
        const last = focusable[focusable.length - 1];

        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      },

      closeAll() {
        [...state.openModals].forEach((id) => this.close(id));
      },
    };

    // ============================================================================
    // 6. DONN√âES : CHARGEMENT & SAUVEGARDE
    // ============================================================================
    function loadLinks() {
      const stored = storage.get(STORAGE_KEYS.LINKS);
      if (stored) {
        state.links = stored.map((l, i) => ({
          ...l,
          id: l.id || `migrated-${i}`,
          tab: l.tab || "custom",
        }));
      } else {
        state.links = DEFAULT_LINKS.map((l, i) => ({ ...l, id: `default-${i}` }));
        saveLinks();
      }
    }

    function saveLinks() {
      storage.set(STORAGE_KEYS.LINKS, state.links);
    }

    function loadTitleSettings() {
      const stored = storage.get(STORAGE_KEYS.TITLE);
      if (stored) {
        state.titleSettings = {
          ...DEFAULT_TITLE_SETTINGS,
          ...stored,
          cameras: stored.cameras || DEFAULT_TITLE_SETTINGS.cameras,
        };
      }
    }

    function saveTitleSettings() {
      storage.set(STORAGE_KEYS.TITLE, state.titleSettings);
    }

    async function loadAuthSettings() {
      const stored = storage.get(STORAGE_KEYS.AUTH);
      if (stored) {
        state.authSettings = { ...DEFAULT_AUTH, ...stored };

        // Migration ancien format
        if (!state.authSettings.passwordHash && stored.password) {
          state.authSettings.passwordHash = await hashPassword(stored.password);
          delete state.authSettings.password;
          saveAuthSettings();
        }

        // Normalisation
        const normalized = normalizePasswordHash(state.authSettings.passwordHash);
        if (!normalized) {
          state.authSettings.passwordHash = DEFAULT_AUTH.passwordHash;
          saveAuthSettings();
        } else {
          state.authSettings.passwordHash = normalized;
        }

        if (!state.authSettings.username) {
          state.authSettings.username = DEFAULT_AUTH.username;
        }
      }
      ensureAuthDefaultsPersisted();
    }

    function saveAuthSettings() {
      storage.set(STORAGE_KEYS.AUTH, {
        username: state.authSettings.username,
        passwordHash: state.authSettings.passwordHash,
      });
    }

    function ensureAuthDefaultsPersisted() {
      let updated = false;
      if (!state.authSettings.username) {
        state.authSettings.username = DEFAULT_AUTH.username;
        updated = true;
      }
      const normalizedHash = normalizePasswordHash(state.authSettings.passwordHash);
      if (!normalizedHash) {
        state.authSettings.passwordHash = DEFAULT_AUTH.passwordHash;
        updated = true;
      } else if (normalizedHash !== state.authSettings.passwordHash) {
        state.authSettings.passwordHash = normalizedHash;
        updated = true;
      }
      if (updated) saveAuthSettings();
    }

    function loadTabState() {
      const stored = storage.get(STORAGE_KEYS.TAB);
      if (stored && TABS.some((t) => t.id === stored)) {
        state.uiState.activeTab = stored;
      }
    }

    function saveTabState() {
      storage.set(STORAGE_KEYS.TAB, state.uiState.activeTab);
    }

    // ============================================================================
    // 7. AUTHENTIFICATION
    // ============================================================================
    function hasValidAuthSession() {
      return Boolean(cookies.get(AUTH_COOKIE_NAME));
    }

    function setAuthCookieForDay() {
      const expiry = new Date();
      expiry.setHours(23, 59, 59, 999);
      cookies.set(AUTH_COOKIE_NAME, "1", expiry);
    }

    function clearAuthCookie() {
      cookies.delete(AUTH_COOKIE_NAME);
    }

    function resetAuthToDefaults(statusMessage = "") {
      state.authSettings = { ...DEFAULT_AUTH };
      saveAuthSettings();
      updateAuthOverlayFields();

      const authUserInput = $("portal-auth-user");
      const authPassInput = $("portal-auth-pass");
      if (authUserInput) authUserInput.value = state.authSettings.username;
      if (authPassInput) authPassInput.value = "";

      clearAuthCookie();
      const statusEl = $("auth-status");
      if (statusEl && statusMessage) {
        statusEl.innerHTML = `<span class="ok">${statusMessage}</span>`;
      }
    }

    function updateAuthOverlayFields(clearPassword = true) {
      const userInput = $("auth-username");
      const passInput = $("auth-password");
      if (userInput) userInput.value = state.authSettings.username || "";
      if (passInput) {
        passInput.type = "password";
        if (clearPassword) passInput.value = "";
      }
    }

    function showAuthOverlay(message = "") {
      updateAuthOverlayFields();
      const statusEl = $("auth-status");
      if (statusEl) statusEl.innerHTML = message;
      modalManager.open("auth-overlay");
      setTimeout(() => $("auth-username")?.focus(), 0);
    }

    function hideAuthOverlay() {
      modalManager.close("auth-overlay");
      const statusEl = $("auth-status");
      if (statusEl) statusEl.innerHTML = "";
      updateAuthOverlayFields();
    }

    function enforceAuthSession() {
      if (hasValidAuthSession()) {
        hideAuthOverlay();
      } else {
        showAuthOverlay();
      }
    }

    function handleAuthSessionAfterSettings(credentialsChanged) {
      if (credentialsChanged) {
        clearAuthCookie();
        showAuthOverlay('<span class="ok">Identifiants mis √† jour, merci de vous reconnecter.</span>');
      } else {
        setAuthCookieForDay();
      }
    }

    function setupAuthOverlay() {
      const form = $("auth-form");
      const userInput = $("auth-username");
      const passInput = $("auth-password");
      const statusEl = $("auth-status");
      const resetBtn = $("auth-reset-btn");

      if (!form || !userInput || !passInput) return;

      if (resetBtn) {
        resetBtn.addEventListener("click", () => {
          const msg = "Identifiants r√©initialis√©s. Connecte-toi avec <strong>admin</strong> / <strong>admin</strong>.";
          resetAuthToDefaults(msg);
          showAuthOverlay(`<span class="ok">${msg}</span>`);
        });
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = userInput.value.trim();
        const password = passInput.value;

        if (!username || !password) {
          if (statusEl) statusEl.innerHTML = '<span class="err">Merci de renseigner les deux champs.</span>';
          return;
        }

        ensureAuthDefaultsPersisted();

        const storedHash = normalizePasswordHash(state.authSettings.passwordHash);
        if (!storedHash) {
          resetAuthToDefaults("Identifiants corrompus r√©initialis√©s. Utilise <strong>admin</strong> / <strong>admin</strong>.");
          updateAuthOverlayFields();
          return;
        }

        state.authSettings.passwordHash = storedHash;
        const passwordHash = await hashPassword(password);

        if (username === state.authSettings.username && passwordHash === storedHash) {
          setAuthCookieForDay();
          if (statusEl) statusEl.innerHTML = '<span class="ok">Connexion r√©ussie. Bon retour !</span>';
          setTimeout(() => hideAuthOverlay(), 180);
        } else if (statusEl) {
          statusEl.innerHTML = '<span class="err">Identifiants incorrects.</span>';
        }
      });
    }

    // ============================================================================
    // 8. TH√àME & UI
    // ============================================================================
    function applyTheme() {
      const theme = state.titleSettings.theme || "dark";
      document.documentElement.setAttribute("data-theme", theme);
    }

    function applyTitleSettings() {
      const titleEl = $("main-title");
      const subtitleEl = $("subtitle-span");
      const logoCircle = $("logo-circle");

      if (titleEl) titleEl.textContent = state.titleSettings.title || "";
      if (subtitleEl) subtitleEl.textContent = state.titleSettings.subtitle || "";

      if (logoCircle) {
        logoCircle.innerHTML = "";
        const logoSource = state.titleSettings.logoImageUrl || state.titleSettings.logoImage;
        if (logoSource) {
          const img = document.createElement("img");
          img.src = logoSource;
          img.alt = state.titleSettings.logoText || "Logo";
          logoCircle.appendChild(img);
        } else {
          const span = document.createElement("span");
          span.id = "logo-text";
          span.textContent = state.titleSettings.logoText || "HL";
          logoCircle.appendChild(span);
        }
      }
    }

    function updateClock() {
      const el = $("clock");
      if (!el) return;
      const now = new Date();
      el.textContent = [now.getHours(), now.getMinutes(), now.getSeconds()]
        .map((n) => String(n).padStart(2, "0"))
        .join(":");
    }

    // ============================================================================
    // 9. ONGLETS (TABS)
    // ============================================================================
    function renderTabs() {
      const container = $("tabs");
      if (!container) return;
      container.innerHTML = "";

      TABS.forEach((tab, index) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "tab-btn" + (tab.id === state.uiState.activeTab ? " active" : "");
        btn.dataset.tab = tab.id;
        btn.setAttribute("role", "tab");
        btn.setAttribute("aria-selected", tab.id === state.uiState.activeTab ? "true" : "false");
        btn.setAttribute("tabindex", tab.id === state.uiState.activeTab ? "0" : "-1");
        btn.innerHTML = `<span aria-hidden="true">${tab.icon}</span>${tab.label}`;

        btn.addEventListener("click", () => {
          state.uiState.activeTab = tab.id;
          saveTabState();
          renderTabs();
          renderTiles($("search")?.value || "");
        });

        // Navigation clavier dans les onglets
        btn.addEventListener("keydown", (e) => {
          const tabs = [...container.querySelectorAll(".tab-btn")];
          const currentIndex = tabs.indexOf(btn);
          let newIndex = currentIndex;

          if (e.key === "ArrowRight" || e.key === "ArrowDown") {
            e.preventDefault();
            newIndex = (currentIndex + 1) % tabs.length;
          } else if (e.key === "ArrowLeft" || e.key === "ArrowUp") {
            e.preventDefault();
            newIndex = (currentIndex - 1 + tabs.length) % tabs.length;
          } else if (e.key === "Home") {
            e.preventDefault();
            newIndex = 0;
          } else if (e.key === "End") {
            e.preventDefault();
            newIndex = tabs.length - 1;
          }

          if (newIndex !== currentIndex) {
            tabs[newIndex].focus();
            tabs[newIndex].click();
          }
        });

        container.appendChild(btn);
      });
    }

    function populateTabSelect() {
      const select = $("shortcut-tab");
      if (!select) return;
      select.innerHTML = "";
      TABS.filter((t) => t.id !== "all").forEach((tab) => {
        const opt = document.createElement("option");
        opt.value = tab.id;
        opt.textContent = tab.label;
        select.appendChild(opt);
      });
    }

    // ============================================================================
    // 10. TILES (RACCOURCIS)
    // ============================================================================
    function createTile(link) {
      const tile = document.createElement("article");
      tile.className = "tile";
      tile.setAttribute("role", "listitem");
      tile.setAttribute("tabindex", "0");
      tile.setAttribute("aria-label", `${link.name || "Service"} ‚Äì ${link.description || link.url || "Ouvrir"}`);

      const openLink = () => {
        if (link.url) window.open(link.url, "_blank", "noopener,noreferrer");
      };

      tile.addEventListener("click", openLink);
      tile.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          openLink();
        }
      });

      // Header
      const header = document.createElement("div");
      header.className = "tile-header";

      const logo = document.createElement("div");
      logo.className = "tile-logo";
      if (isImageIcon(link.icon)) {
        const img = document.createElement("img");
        img.src = link.icon;
        img.alt = "";
        logo.appendChild(img);
      } else {
        logo.textContent = link.icon || (link.name ? link.name[0] : "?");
      }

      const titleBox = document.createElement("div");
      const title = document.createElement("div");
      title.className = "tile-title";
      title.textContent = link.name || "Service";

      const sub = document.createElement("div");
      sub.className = "tile-sub";
      sub.textContent = link.description || link.url || "";

      titleBox.appendChild(title);
      titleBox.appendChild(sub);
      header.appendChild(logo);
      header.appendChild(titleBox);
      tile.appendChild(header);

      // Chip
      if (link.chip) {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = link.chip;
        tile.appendChild(chip);
      }

      // Bouton √©diter
      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.className = "tile-edit";
      editBtn.title = "Modifier ce raccourci";
      editBtn.setAttribute("aria-label", `Modifier ${link.name}`);
      editBtn.textContent = "‚úèÔ∏è";
      editBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        openShortcutModal("edit", link.id);
      });
      tile.appendChild(editBtn);

      // Status dot
      const statusDot = document.createElement("div");
      statusDot.className = "tile-status-dot tile-status-unknown";
      statusDot.title = "√âtat : inconnu";
      statusDot.setAttribute("aria-hidden", "true");
      tile.appendChild(statusDot);
      state.statusDots[link.id] = statusDot;

      return tile;
    }

    function renderTiles(filter = "") {
      const container = $("tiles");
      if (!container) return;
      container.innerHTML = "";
      state.statusDots = {};
      const f = filter.trim().toLowerCase();

      let visibleCount = 0;
      state.links.forEach((link) => {
        const tab = link.tab || "custom";
        if (state.uiState.activeTab !== "all" && tab !== state.uiState.activeTab) return;

        const hay = `${link.name || ""} ${link.description || ""}`.toLowerCase();
        if (f && !hay.includes(f)) return;

        container.appendChild(createTile(link));
        visibleCount++;
      });

      if (!visibleCount) {
        const msg = document.createElement("div");
        msg.className = "tiles-empty";
        msg.textContent = "Aucun service pour cet onglet / filtre. Ajoute un raccourci avec le + ou restaure les valeurs par d√©faut.";
        container.appendChild(msg);
      }
    }

    // ============================================================================
    // 11. MODAL RACCOURCIS
    // ============================================================================
    function openShortcutModal(mode = "new", id = null) {
      const titleEl = $("modal-title");
      const deleteBtn = $("btn-delete");
      const status = $("status");
      const fileNameEl = $("file-name");
      const form = $("shortcut-form");
      const inputName = $("name");
      const inputUrl = $("url");
      const tabSelect = $("shortcut-tab");
      const logoUrlInput = $("logo-url");
      const healthUrlInput = $("health-url");

      state.logoDataUrl = null;
      if (status) status.innerHTML = "";
      if (fileNameEl) fileNameEl.textContent = "(aucun fichier)";
      if (logoUrlInput) logoUrlInput.value = "";
      if (healthUrlInput) healthUrlInput.value = "";
      if (form) form.reset();

      if (mode === "edit" && id) {
        const link = state.links.find((l) => l.id === id);
        if (!link) return;

        state.currentEditId = id;
        if (titleEl) titleEl.innerHTML = '<span>Modifier</span> le raccourci';
        if (inputName) inputName.value = link.name || "";
        if (inputUrl) inputUrl.value = link.url || "";
        if (tabSelect) tabSelect.value = link.tab || "custom";
        if (logoUrlInput) {
          logoUrlInput.value = link.icon?.startsWith("http") ? link.icon : "";
        }
        if (healthUrlInput) healthUrlInput.value = link.healthUrl || "";
        if (deleteBtn) deleteBtn.style.display = "inline-flex";
      } else {
        state.currentEditId = null;
        if (titleEl) titleEl.innerHTML = '<span>Ajouter</span> un raccourci';
        if (deleteBtn) deleteBtn.style.display = "none";
        if (tabSelect) tabSelect.value = state.uiState.activeTab !== "all" ? state.uiState.activeTab : "custom";
      }

      modalManager.open("modal");
      setTimeout(() => inputName?.focus(), 0);
    }

    function closeShortcutModal() {
      modalManager.close("modal");
      state.currentEditId = null;
      state.logoDataUrl = null;
    }

    function setupShortcutForm() {
      const form = $("shortcut-form");
      const inputName = $("name");
      const inputUrl = $("url");
      const tabSelect = $("shortcut-tab");
      const inputLogo = $("logo");
      const inputLogoUrl = $("logo-url");
      const inputHealthUrl = $("health-url");
      const fileName = $("file-name");
      const status = $("status");
      const btnNewResetForm = $("btn-new-reset-form");
      const btnDelete = $("btn-delete");
      const btnEmptyAll = $("btn-empty-all");
      const btnRestoreDefaults = $("btn-restore-defaults");

      if (!form) return;

      inputLogo?.addEventListener("change", () => {
        const file = inputLogo.files?.[0];
        if (!file) {
          if (fileName) fileName.textContent = "(aucun fichier)";
          state.logoDataUrl = null;
          return;
        }
        if (file.size > CONFIG.MAX_IMAGE_SIZE) {
          if (status) status.innerHTML = '<span class="err">Fichier trop gros (max ~100 Ko).</span>';
          inputLogo.value = "";
          if (fileName) fileName.textContent = "(aucun fichier)";
          state.logoDataUrl = null;
          return;
        }
        if (fileName) fileName.textContent = file.name;
        const reader = new FileReader();
        reader.onload = (e) => (state.logoDataUrl = e.target.result);
        reader.readAsDataURL(file);
      });

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const name = inputName?.value.trim();
        const url = inputUrl?.value.trim();
        const tab = tabSelect?.value || "custom";
        const logoExternal = inputLogoUrl?.value.trim();
        const healthUrl = inputHealthUrl?.value.trim();

        if (!name || !url) {
          if (status) status.innerHTML = '<span class="err">Merci de remplir au moins le nom et l\'URL.</span>';
          return;
        }

        if (state.currentEditId) {
          const index = state.links.findIndex((l) => l.id === state.currentEditId);
          if (index !== -1) {
            const existing = state.links[index];
            state.links[index] = {
              ...existing,
              name,
              url,
              description: existing.description || url,
              icon: logoExternal || state.logoDataUrl || existing.icon,
              healthUrl: healthUrl || existing.healthUrl || "",
              tab,
            };
          }
          if (status) status.innerHTML = '<span class="ok">Raccourci mis √† jour.</span>';
        } else {
          state.links.push({
            id: generateId("link"),
            name,
            url,
            description: url,
            chip: "Custom",
            icon: logoExternal || state.logoDataUrl || "‚≠ê",
            healthUrl,
            tab,
          });
          if (status) status.innerHTML = '<span class="ok">Nouveau raccourci ajout√© !</span>';
        }

        saveLinks();
        renderTiles($("search")?.value || "");
      });

      btnNewResetForm?.addEventListener("click", () => {
        form.reset();
        state.logoDataUrl = null;
        if (fileName) fileName.textContent = "(aucun fichier)";
        state.currentEditId = null;
        const titleEl = $("modal-title");
        if (titleEl) titleEl.innerHTML = '<span>Ajouter</span> un raccourci';
        if (btnDelete) btnDelete.style.display = "none";
        if (status) status.innerHTML = "";
        if (tabSelect) tabSelect.value = state.uiState.activeTab !== "all" ? state.uiState.activeTab : "custom";
        if (inputLogoUrl) inputLogoUrl.value = "";
        if (inputHealthUrl) inputHealthUrl.value = "";
      });

      btnDelete?.addEventListener("click", () => {
        if (!state.currentEditId) return;
        if (!confirm("Supprimer d√©finitivement ce raccourci ?")) return;
        state.links = state.links.filter((l) => l.id !== state.currentEditId);
        saveLinks();
        renderTiles($("search")?.value || "");
        closeShortcutModal();
      });

      btnEmptyAll?.addEventListener("click", () => {
        if (!state.links.length || !confirm("Supprimer tous les raccourcis ?")) return;
        state.links = [];
        saveLinks();
        renderTiles($("search")?.value || "");
        if (status) status.innerHTML = '<span class="ok">Tous les raccourcis ont √©t√© vid√©s.</span>';
      });

      btnRestoreDefaults?.addEventListener("click", () => {
        if (!confirm("Restaurer les raccourcis par d√©faut ?")) return;
        state.links = DEFAULT_LINKS.map((l, i) => ({ ...l, id: `default-${i}` }));
        saveLinks();
        renderTiles($("search")?.value || "");
        if (status) status.innerHTML = '<span class="ok">Raccourcis par d√©faut restaur√©s.</span>';
      });
    }

    // ============================================================================
    // 12. MODAL PARAM√àTRES
    // ============================================================================
    function buildCameraSettingsFields() {
      const container = $("camera-settings-fields");
      if (!container) return;
      container.innerHTML = "";
      state.titleSettings.cameras.forEach((cam, index) => {
        const wrap = document.createElement("div");
        wrap.className = "form-group";
        wrap.innerHTML = `
          <label>Cam√©ra ${index + 1}</label>
          <input type="text" id="camera-name-${index}" placeholder="Nom (ex : Entr√©e)" style="margin-bottom:4px;" />
          <input type="url" id="camera-snapshot-${index}" placeholder="URL snapshot HTTP" style="margin-bottom:4px;" />
          <input type="url" id="camera-click-${index}" placeholder="URL au clic (page NVR / Frigate)" />
        `;
        container.appendChild(wrap);
      });
    }

    function openSettingsModal() {
      const titleInput = $("portal-title-input");
      const subtitleInput = $("portal-subtitle-input");
      const logoTextInput = $("portal-logo-text");
      const logoUrlInput = $("portal-logo-url");
      const fileNameEl = $("portal-logo-filename");
      const themeSelect = $("portal-theme-select");
      const authUserInput = $("portal-auth-user");
      const authPassInput = $("portal-auth-pass");
      const status = $("settings-status");

      if (titleInput) titleInput.value = state.titleSettings.title || "";
      if (subtitleInput) subtitleInput.value = state.titleSettings.subtitle || "";
      if (logoTextInput) logoTextInput.value = state.titleSettings.logoText || "HL";
      if (logoUrlInput) logoUrlInput.value = state.titleSettings.logoImageUrl || "";
      if (themeSelect) themeSelect.value = state.titleSettings.theme || "dark";
      if (authUserInput) authUserInput.value = state.authSettings.username || DEFAULT_AUTH.username;
      if (authPassInput) authPassInput.value = "";

      state.portalLogoDataUrl = null;
      if (status) status.innerHTML = "";

      if (fileNameEl) {
        fileNameEl.textContent = state.titleSettings.logoImage || state.titleSettings.logoImageUrl
          ? "(logo actuel charg√©)"
          : "(aucun fichier)";
      }

      state.titleSettings.cameras.forEach((cam, index) => {
        const nameEl = $(`camera-name-${index}`);
        const snapEl = $(`camera-snapshot-${index}`);
        const clickEl = $(`camera-click-${index}`);
        if (nameEl) nameEl.value = cam.name || "";
        if (snapEl) snapEl.value = cam.snapshotUrl || "";
        if (clickEl) clickEl.value = cam.clickUrl || "";
      });

      modalManager.open("settings-modal");
      setTimeout(() => titleInput?.focus(), 0);
    }

    function closeSettingsModal() {
      modalManager.close("settings-modal");
      state.portalLogoDataUrl = null;
    }

    function setupSettingsForm() {
      const form = $("settings-form");
      const titleInput = $("portal-title-input");
      const subtitleInput = $("portal-subtitle-input");
      const logoTextInput = $("portal-logo-text");
      const logoUrlInput = $("portal-logo-url");
      const logoFileInput = $("portal-logo-file");
      const fileNameEl = $("portal-logo-filename");
      const themeSelect = $("portal-theme-select");
      const authUserInput = $("portal-auth-user");
      const authPassInput = $("portal-auth-pass");
      const status = $("settings-status");
      const btnResetTitle = $("btn-reset-title");

      if (!form) return;

      logoFileInput?.addEventListener("change", () => {
        const file = logoFileInput.files?.[0];
        if (!file) {
          if (fileNameEl) fileNameEl.textContent = "(aucun fichier)";
          state.portalLogoDataUrl = null;
          return;
        }
        if (file.size > CONFIG.MAX_IMAGE_SIZE) {
          if (status) status.innerHTML = '<span class="err">Logo trop lourd (max ~100 Ko).</span>';
          logoFileInput.value = "";
          if (fileNameEl) fileNameEl.textContent = "(aucun fichier)";
          state.portalLogoDataUrl = null;
          return;
        }
        if (fileNameEl) fileNameEl.textContent = file.name;
        const reader = new FileReader();
        reader.onload = (e) => (state.portalLogoDataUrl = e.target.result);
        reader.readAsDataURL(file);
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const title = titleInput?.value.trim();
        const subtitle = subtitleInput?.value.trim();
        const logoText = logoTextInput?.value.trim() || "HL";
        const logoExternal = logoUrlInput?.value.trim();
        const theme = themeSelect?.value || "dark";
        const authUser = authUserInput?.value.trim();
        const authPass = authPassInput?.value;
        const previousAuth = { ...state.authSettings };

        if (!title || !subtitle) {
          if (status) status.innerHTML = '<span class="err">Titre et sous-titre requis.</span>';
          return;
        }

        if (!authUser) {
          if (status) status.innerHTML = '<span class="err">Identifiant requis.</span>';
          return;
        }

        state.titleSettings.title = title;
        state.titleSettings.subtitle = subtitle;
        state.titleSettings.logoText = logoText;
        state.titleSettings.theme = theme;

        let passwordChanged = false;
        state.authSettings.username = authUser;
        if (authPass) {
          const hashed = await hashPassword(authPass);
          state.authSettings.passwordHash = normalizePasswordHash(hashed) || DEFAULT_AUTH.passwordHash;
          passwordChanged = true;
        }

        if (logoExternal) {
          state.titleSettings.logoImageUrl = logoExternal;
          state.titleSettings.logoImage = null;
        } else if (state.portalLogoDataUrl) {
          state.titleSettings.logoImage = state.portalLogoDataUrl;
          state.titleSettings.logoImageUrl = "";
        }

        const cams = [];
        state.titleSettings.cameras.forEach((_, index) => {
          const nameEl = $(`camera-name-${index}`);
          const snapEl = $(`camera-snapshot-${index}`);
          const clickEl = $(`camera-click-${index}`);
          cams.push({
            name: nameEl?.value.trim() || "",
            snapshotUrl: snapEl?.value.trim() || "",
            clickUrl: clickEl?.value.trim() || "",
          });
        });
        state.titleSettings.cameras = cams;

        saveAuthSettings();
        ensureAuthDefaultsPersisted();
        updateAuthOverlayFields(false);
        handleAuthSessionAfterSettings(previousAuth.username !== state.authSettings.username || passwordChanged);

        saveTitleSettings();
        applyTheme();
        applyTitleSettings();
        renderCameras();

        if (status) status.innerHTML = '<span class="ok">Param√®tres sauvegard√©s.</span>';
      });

      btnResetTitle?.addEventListener("click", () => {
        if (!confirm("Revenir aux valeurs par d√©faut ?")) return;

        state.titleSettings = { ...DEFAULT_TITLE_SETTINGS };
        state.authSettings = { ...DEFAULT_AUTH };

        if (authUserInput) authUserInput.value = state.authSettings.username;
        if (authPassInput) authPassInput.value = "";

        saveAuthSettings();
        ensureAuthDefaultsPersisted();
        updateAuthOverlayFields();
        handleAuthSessionAfterSettings(true);

        saveTitleSettings();
        applyTheme();
        applyTitleSettings();
        renderCameras();

        if (titleInput) titleInput.value = state.titleSettings.title;
        if (subtitleInput) subtitleInput.value = state.titleSettings.subtitle;
        if (logoTextInput) logoTextInput.value = state.titleSettings.logoText;
        if (logoUrlInput) logoUrlInput.value = "";
        if (logoFileInput) logoFileInput.value = "";
        if (fileNameEl) fileNameEl.textContent = "(aucun fichier)";
        if (themeSelect) themeSelect.value = state.titleSettings.theme;

        buildCameraSettingsFields();

        if (status) status.innerHTML = '<span class="ok">Valeurs par d√©faut restaur√©es.</span>';
      });
    }

    // ============================================================================
    // 13. CAM√âRAS
    // ============================================================================
    function renderCameras() {
      const strip = $("camera-strip");
      if (!strip) return;
      strip.innerHTML = "";

      state.titleSettings.cameras.forEach((cam, index) => {
        const card = document.createElement("div");
        card.className = "camera-card";
        card.setAttribute("role", "button");
        card.setAttribute("tabindex", "0");
        card.setAttribute("aria-label", `${cam.name || `Cam√©ra ${index + 1}`}${cam.snapshotUrl ? " : aper√ßu" : " : √† configurer"}`);

        const openCamera = () => openCameraModal(cam);
        card.addEventListener("click", openCamera);
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            openCamera();
          }
        });

        const inner = document.createElement("div");
        inner.className = "camera-card-inner";

        if (cam.snapshotUrl) {
          const img = document.createElement("img");
          img.dataset.base = cam.snapshotUrl;
          img.alt = cam.name || `Cam√©ra ${index + 1}`;
          img.addEventListener("error", () => (img.style.display = "none"));
          inner.appendChild(img);
        } else {
          const placeholder = document.createElement("div");
          placeholder.className = "camera-placeholder";
          placeholder.textContent = "Configure cette cam√©ra dans les param√®tres.";
          inner.appendChild(placeholder);
        }

        const overlay = document.createElement("div");
        overlay.className = "camera-overlay";
        overlay.setAttribute("aria-hidden", "true");

        const label = document.createElement("div");
        label.className = "camera-label";
        label.textContent = cam.name || `Cam√©ra ${index + 1}`;

        card.appendChild(inner);
        card.appendChild(overlay);
        card.appendChild(label);
        strip.appendChild(card);
      });

      refreshCameraSnapshots(true);
    }

    function refreshCameraSnapshots(initial = false) {
      $$(".camera-card img").forEach((img) => {
        const base = img.dataset.base;
        if (!base) return;
        const sep = base.includes("?") ? "&" : "?";
        img.src = initial ? base : `${base}${sep}t=${Date.now()}`;
        img.style.display = "block";
      });
    }

    function openCameraModal(cam) {
      const nameEl = $("camera-modal-name");
      const imgEl = $("camera-modal-img");
      const placeholderEl = $("camera-modal-placeholder");
      const statusEl = $("camera-modal-status");
      const openTabBtn = $("camera-modal-open-tab");

      // Stop ancien intervalle
      if (state.cameraModalIntervalId) {
        clearInterval(state.cameraModalIntervalId);
        state.cameraModalIntervalId = null;
      }

      state.currentCameraModal = {
        name: cam.name || "",
        snapshotUrl: cam.snapshotUrl || "",
        clickUrl: cam.clickUrl || "",
      };

      if (nameEl) nameEl.textContent = state.currentCameraModal.name || "Cam√©ra";
      if (statusEl) statusEl.innerHTML = "";

      if (state.currentCameraModal.snapshotUrl) {
        const base = state.currentCameraModal.snapshotUrl;
        const sep = base.includes("?") ? "&" : "?";

        const loadFrame = () => {
          if (imgEl) {
            imgEl.style.display = "block";
            imgEl.src = `${base}${sep}t=${Date.now()}`;
          }
          if (placeholderEl) placeholderEl.style.display = "none";
        };

        if (imgEl) {
          imgEl.onerror = () => {
            imgEl.style.display = "none";
            if (placeholderEl) placeholderEl.style.display = "flex";
            if (statusEl) statusEl.innerHTML = '<span class="err">Impossible de charger le flux.</span>';
          };
        }

        loadFrame();
        state.cameraModalIntervalId = setInterval(loadFrame, CONFIG.CAMERA_MODAL_REFRESH);
      } else {
        if (imgEl) imgEl.style.display = "none";
        if (placeholderEl) placeholderEl.style.display = "flex";
      }

      if (openTabBtn) {
        openTabBtn.disabled = !state.currentCameraModal.clickUrl;
        openTabBtn.classList.toggle("btn-primary", !!state.currentCameraModal.clickUrl);
        openTabBtn.classList.toggle("btn-secondary", !state.currentCameraModal.clickUrl);
      }

      modalManager.open("camera-modal");
      setTimeout(() => $("camera-modal-close")?.focus(), 0);
    }

    function closeCameraModal() {
      modalManager.close("camera-modal");
      if (state.cameraModalIntervalId) {
        clearInterval(state.cameraModalIntervalId);
        state.cameraModalIntervalId = null;
      }
    }

    // ============================================================================
    // 14. HEALTH CHECKS
    // ============================================================================
    function setStatus(linkId, status) {
      const dot = state.statusDots[linkId];
      if (!dot) return;

      dot.classList.remove("tile-status-up", "tile-status-down", "tile-status-unknown");

      if (status === "up") {
        dot.classList.add("tile-status-up");
        dot.title = "√âtat : UP (accessible)";
      } else if (status === "down") {
        dot.classList.add("tile-status-down");
        dot.title = "√âtat : DOWN (erreur)";
      } else {
        dot.classList.add("tile-status-unknown");
        dot.title = "√âtat : inconnu";
      }
    }

    function getHealthUrl(link) {
      if (link.healthUrl?.trim()) return link.healthUrl.trim();
      if (!link.url) return null;
      const trimmed = link.url.endsWith("/") ? link.url.slice(0, -1) : link.url;
      return `${trimmed}${CONFIG.DEFAULT_HEALTH_PATH}`;
    }

    function pingLinkWithImage(url, linkId) {
      const img = new Image();
      let resolved = false;
      const timeout = setTimeout(() => {
        if (resolved) return;
        resolved = true;
        setStatus(linkId, "down");
      }, CONFIG.HEALTH_TIMEOUT);

      img.onload = () => {
        if (resolved) return;
        resolved = true;
        clearTimeout(timeout);
        setStatus(linkId, "up");
      };

      img.onerror = () => {
        if (resolved) return;
        resolved = true;
        clearTimeout(timeout);
        setStatus(linkId, "down");
      };

      img.referrerPolicy = "no-referrer";
      img.decoding = "async";
      const sep = url.includes("?") ? "&" : "?";
      img.src = `${url}${sep}t=${Date.now()}`;
    }

    function pingLinkNoCors(url, linkId) {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), CONFIG.HEALTH_TIMEOUT);

      fetch(url, {
        mode: "no-cors",
        cache: "no-store",
        redirect: "follow",
        signal: controller.signal,
      })
        .then(() => {
          clearTimeout(timeout);
          // En no-cors, si on arrive ici sans erreur, le serveur a r√©pondu
          setStatus(linkId, "up");
        })
        .catch(() => {
          clearTimeout(timeout);
          // Dernier recours : essai via image (favicon ou URL directe)
          pingLinkWithImage(url, linkId);
        });
    }

    function pingLink(link) {
      const url = getHealthUrl(link);
      if (!url) {
        setStatus(link.id, "unknown");
        return;
      }

      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), CONFIG.HEALTH_TIMEOUT);

      fetch(url, {
        mode: "cors",
        cache: "no-store",
        redirect: "follow",
        signal: controller.signal,
      })
        .then((response) => {
          clearTimeout(timeout);
          if (response.ok) {
            setStatus(link.id, "up");
          } else if (response.type === "opaque") {
            // R√©ponse opaque en CORS = serveur a r√©pondu
            setStatus(link.id, "up");
          } else {
            setStatus(link.id, "down");
          }
        })
        .catch(() => {
          clearTimeout(timeout);
          // Fallback 1 : essai en mode no-cors
          pingLinkNoCors(url, link.id);
        });
    }

    function scheduleHealthChecks() {
      state.links.forEach((link) => pingLink(link));
      setInterval(() => {
        state.links.forEach((link) => pingLink(link));
      }, CONFIG.HEALTH_CHECK_INTERVAL);
    }

    // ============================================================================
    // 15. RECHERCHE
    // ============================================================================
    function setupSearch() {
      const search = $("search");
      if (!search) return;

      let debounceTimer;
      search.addEventListener("input", () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          renderTiles(search.value);
        }, 100);
      });
    }

    // ============================================================================
    // 16. TOGGLE MOT DE PASSE
    // ============================================================================
    function setupPasswordVisibilityToggle(inputId, toggleId) {
      const input = $(inputId);
      const toggle = $(toggleId);
      if (!input || !toggle) return;

      const show = () => {
        input.type = "text";
        toggle.classList.add("password-visible");
      };

      const hide = () => {
        input.type = "password";
        toggle.classList.remove("password-visible");
      };

      ["mousedown", "touchstart"].forEach((evt) => {
        toggle.addEventListener(evt, (e) => {
          e.preventDefault();
          show();
          input.focus();
        });
      });

      ["mouseup", "mouseleave", "touchend", "touchcancel", "blur"].forEach((evt) => {
        toggle.addEventListener(evt, hide);
      });

      input.addEventListener("blur", hide);

      toggle.addEventListener("keydown", (e) => {
        if (e.key === " " || e.key === "Enter") {
          e.preventDefault();
          show();
        }
      });

      toggle.addEventListener("keyup", hide);
    }

    // ============================================================================
    // 17. INITIALISATION
    // ============================================================================
    document.addEventListener("DOMContentLoaded", async () => {
      // Chargement des donn√©es
      await loadAuthSettings();
      loadTitleSettings();
      loadTabState();
      loadLinks();

      // Application du th√®me et des param√®tres
      applyTheme();
      applyTitleSettings();

      // Construction de l'UI
      buildCameraSettingsFields();
      renderCameras();
      populateTabSelect();
      renderTabs();
      renderTiles();

      // Setup des formulaires et √©v√©nements
      setupSearch();
      setupShortcutForm();
      setupSettingsForm();
      setupAuthOverlay();
      setupPasswordVisibilityToggle("auth-password", "auth-password-toggle");
      setupPasswordVisibilityToggle("portal-auth-pass", "portal-auth-pass-toggle");

      // Horloge et rafra√Æchissement p√©riodique
      updateClock();
      setInterval(updateClock, CONFIG.CLOCK_INTERVAL);
      setInterval(() => refreshCameraSnapshots(false), CONFIG.CAMERA_STRIP_REFRESH);

      // Health checks
      scheduleHealthChecks();

      // √âv√©nements des boutons FAB
      $("btn-open-modal")?.addEventListener("click", () => openShortcutModal("new", null));
      $("modal-close")?.addEventListener("click", closeShortcutModal);
      $("modal")?.addEventListener("click", (e) => {
        if (e.target === $("modal")) closeShortcutModal();
      });

      $("btn-open-settings")?.addEventListener("click", openSettingsModal);
      $("settings-close")?.addEventListener("click", closeSettingsModal);
      $("settings-modal")?.addEventListener("click", (e) => {
        if (e.target === $("settings-modal")) closeSettingsModal();
      });

      // Modal cam√©ra
      $("camera-modal-close")?.addEventListener("click", closeCameraModal);
      $("camera-modal-close-bottom")?.addEventListener("click", closeCameraModal);
      $("camera-modal")?.addEventListener("click", (e) => {
        if (e.target === $("camera-modal")) closeCameraModal();
      });

      $("camera-modal-open-tab")?.addEventListener("click", () => {
        if (state.currentCameraModal.clickUrl) {
          window.open(state.currentCameraModal.clickUrl, "_blank", "noopener,noreferrer");
        }
      });

      // Fermeture globale avec Escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          modalManager.closeAll();
        }
      });

      // V√©rification session d'authentification
      enforceAuthSession();
    });
  </script>
</body>
</html>
